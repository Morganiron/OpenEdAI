@page "/generate-course"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations
@using OpenEdAI.Client.Models
@using OpenEdAI.Client.Services
@using OpenEdAI.Client.Components
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject LoadingService Loader
@inject IJSRuntime JS
@inject LogoutService LogoutService

<!-- Prevent navigation if required fields are not completed -->
<NavigationLock ConfirmExternalNavigation="true" OnBeforeInternalNavigation="ConfirmNavigationAsync" />

<div class="generate-course-container">
	<h2>Create Your Custom Learning Path</h2>
	<p class="intro-text">
		Welcome to the Course Generator! Based on your preferences, we'll use AI to create a personalized course outline!
	</p>



	@if (generatedPlan != null)
	{
		<CoursePlanDisplay Plan="generatedPlan" />

		<button class="btn btn-success send-button" @onclick="SubmitCoursePlan">Choose this course plan</button>
		<button class="btn btn-clear reset-button" @onclick="ClearCoursePlan">Start Over</button>

		<CoursePlanChat Messages="chatMessages" OnUserMessageSent="HandleUserChatMessage" />
	}
	else
	{
		<CourseInput OnGenerate="HandleCourseInput" />
	}
</div>


@code {
	private CoursePlanDTO generatedPlan;
	private List<CoursePlanChat.ChatMessage> chatMessages = new();
	private bool isLoggingOut = false;

	// Constant strings for local storage keys to persist data
	private const string PlanStorageKey = "cached_generated_plan";
	private const string ChatMessagesKey = "cached_chat_messages";

	// Expiration time in hours (to remove stored items when returning to the page)
	private const int StorageExpiration = 2;

	protected override async Task OnInitializedAsync()
	{
		await LoadGeneratedPlanAsync();
		await LoadChatMessagesAsync();
	}

	private async Task HandleCourseInput(CoursePersonalizationInput input)
	{
		try
		{
			Loader.Show();

			var response = await Http.PostAsJsonAsync("ai/generate-course", input);

			if (response.IsSuccessStatusCode)
			{
				generatedPlan = await response.Content.ReadFromJsonAsync<CoursePlanDTO>();
				chatMessages.Clear();

				// Save the new course plan in local storage
				await SaveGeneratedPlanAsync();
			}
			else
			{
				var error = await response.Content.ReadAsStringAsync();
				Console.WriteLine($"Error generating course: {error}");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Exception generating course: {ex.Message}");
		}
		finally
		{
			Loader.Hide();
		}
	}

	private Task ConfirmNavigationAsync(LocationChangingContext context)
	{
		if (LogoutService.IsLoggingOut)
		{
			// Allow navigation if it's a logout
			return Task.CompletedTask;
		}

		if (generatedPlan == null)
		{
			// Prevent navigating away if a course plan is not generated (shows a confirmation dialog)
			context.PreventNavigation();
		}

		return Task.CompletedTask;
	}

	private async Task HandleUserChatMessage(string userMessage)
	{
		try
		{
			Loader.Show();

			Console.WriteLine("Sending adjustment request...");
			Console.WriteLine($"User message: {userMessage}");

			var serializedPlan = JsonSerializer.Serialize(generatedPlan);
			Console.WriteLine("Serialized generated plan:");
			Console.WriteLine(serializedPlan);

			var requestPayload = new
			{
				UserMessage = userMessage,
				PreviousPlan = serializedPlan
			};

			Console.WriteLine("Making POST request to /ai/adjust-course...");
			var response = await Http.PostAsJsonAsync("ai/adjust-course", requestPayload);

			Console.WriteLine($"Response received: {(int)response.StatusCode} {response.StatusCode}");

			if (response.IsSuccessStatusCode)
			{
				var json = await response.Content.ReadAsStringAsync();
				Console.WriteLine("Raw JSON from response:");
				Console.WriteLine(json);

				var adjustedPlan = JsonSerializer.Deserialize<CoursePlanDTO>(json, new JsonSerializerOptions
					{
						PropertyNameCaseInsensitive = true
					});

				if (adjustedPlan != null)
				{
					generatedPlan = adjustedPlan;
					chatMessages.Add(new CoursePlanChat.ChatMessage
						{
							Text = "Course plan updated based on your request.",
							IsUser = false
						});

					// Save updated Plan and ChateMessages to local storage
					await SaveGeneratedPlanAsync();
					await SaveChatMessagesAsync();
				}
				else
				{
					Console.WriteLine("Deserialization returned null.");
					chatMessages.Add(new CoursePlanChat.ChatMessage
						{
							Text = "The adjustment was processed but no valid plan was returned.",
							IsUser = false
						});
				}
			}
			else
			{
				var error = await response.Content.ReadAsStringAsync();
				Console.WriteLine("Error from backend:");
				Console.WriteLine(error);

				chatMessages.Add(new CoursePlanChat.ChatMessage { Text = "Error processing your request. Please try again.", IsUser = false });
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Exception in HandleUserChatMessage: {ex}");
			chatMessages.Add(new CoursePlanChat.ChatMessage
				{
					Text = "An unexpected error occurred while sending your request.",
					IsUser = false
				});
		}
		finally
		{
			Loader.Hide();
		}
	}
	// Clear the stored CoursePlan and Chat and refresh the page
	private async Task ClearCoursePlan()
	{
		// Show a confirmation popup to the user
		bool shouldClear = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to start over?\nThis will clear your chat and generated course plan.");

		if (shouldClear)
		{
			await JS.InvokeVoidAsync("localStorage.removeItem", PlanStorageKey);
			await JS.InvokeVoidAsync("localStorage.removeItem", ChatMessagesKey);

			// Reset the in-memory state
			generatedPlan = null;
			chatMessages.Clear();

			// Trigger a re-render of the current component
			StateHasChanged();
		}
		
	}


	private async Task SubmitCoursePlan()
	{
		Loader.Show();
		try
		{
			var response = await Http.PostAsJsonAsync("ai/submit-course", generatedPlan);

			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<JsonElement>();
				if (result.TryGetProperty("message", out var messageElement))
				{
					Console.WriteLine($"Backend message: {messageElement.GetString()}");
				}

				// TODO: Add a notification/popup to inform the user that the course is being finalized and they will be notified when it's ready.

				// TODO: Add logic to send data to the backend for processing

				// Clear the localstorage to no longer persist the input information
				await JS.InvokeVoidAsync("localStorage.removeItem", PlanStorageKey);
				await JS.InvokeVoidAsync("localStorage.removeItem", ChatMessagesKey);

				// Redirect to dashboard
				Navigation.NavigateTo("/dashboard");
			}
			else
			{
				var error = await response.Content.ReadAsStringAsync();
				Console.WriteLine($"Error submitting course: {error}");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Exception submitting course: {ex.Message}");
		}
		finally
		{


			Loader.Hide();
		}
	}
	// Method to save the generated plan to local storage
	private async Task SaveGeneratedPlanAsync()
	{
		if (generatedPlan != null)
		{
			var wrapper = new
			{
				Data = generatedPlan,
				Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
			};

			// Serialize the generated plan to a JSON string
			var serialized = JsonSerializer.Serialize(wrapper);
			await JS.InvokeVoidAsync("localStorage.setItem", PlanStorageKey, serialized);
		}
	}
	// Method to load the generated plan from local storage
	private async Task LoadGeneratedPlanAsync()
	{
		var serialized = await JS.InvokeAsync<string>("localStorage.getItem", PlanStorageKey);

		if (!string.IsNullOrEmpty(serialized))
		{
			try
			{
				var wrapper = JsonSerializer.Deserialize<JsonElement>(serialized);
				if (wrapper.ValueKind == JsonValueKind.Object &&
					wrapper.TryGetProperty("Timestamp", out var timestampProp) &&
					wrapper.TryGetProperty("Data", out var dataProp))
				{
					var timestamp = timestampProp.GetInt64();
					var age = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - timestamp;
					if (age < StorageExpiration * 60 * 60 * 1000)
					{
						generatedPlan = JsonSerializer.Deserialize<CoursePlanDTO>(dataProp.GetRawText(), new JsonSerializerOptions
							{
								PropertyNameCaseInsensitive = true
							});
						return;
					}
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Invalid plan format or exception: {ex.Message}");
			}

			// If any of the above fails, clear the old storage
			await JS.InvokeVoidAsync("localStorage.removeItem", PlanStorageKey);

		}
	}
	// Method to save chat messages to local storage
	private async Task SaveChatMessagesAsync()
	{
		if (chatMessages != null)
		{
			var wrapper = new
			{
				Data = chatMessages,
				Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
			};

			// Serialize the generated plan to a JSON string
			var serialized = JsonSerializer.Serialize(wrapper);
			await JS.InvokeVoidAsync("localStorage.setItem", ChatMessagesKey, serialized);
		}
	}
	// Method to load chat messages from local storage
	private async Task LoadChatMessagesAsync()
	{
		var serialized = await JS.InvokeAsync<string>("localStorage.getItem", ChatMessagesKey);

		if (!string.IsNullOrEmpty(serialized))
		{
			try
			{
				var wrapper = JsonSerializer.Deserialize<JsonElement>(serialized);
				if (wrapper.ValueKind == JsonValueKind.Object &&
					wrapper.TryGetProperty("Timestamp", out var timestampProp) &&
					wrapper.TryGetProperty("Data", out var dataProp))
				{
					var timestamp = timestampProp.GetInt64();
					var age = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - timestamp;
					if (age < StorageExpiration * 60 * 60 * 1000)
					{
						chatMessages = JsonSerializer.Deserialize<List<CoursePlanChat.ChatMessage>>(dataProp.GetRawText(), new JsonSerializerOptions
							{
								PropertyNameCaseInsensitive = true
							});
						return;
					}
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Invalid chat format or exception: {ex.Message}");
			}

			// Clear legacy or corrupted data
			await JS.InvokeVoidAsync("localStorage.removeItem", ChatMessagesKey);
		}
	}
}
