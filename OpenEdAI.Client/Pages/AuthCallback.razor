@using System.Text.Json.Serialization
@using System.Text.Json
@using OpenEdAI.Client.Models
@using OpenEdAI.Client.Shared
@page "/auth-callback"
@inject Services.LoadingService Loader
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IJSRuntime JS
@inject Services.TokenManager TokenManager

<GlobalLoading /> 

@code {
	protected override async Task OnInitializedAsync()
	{
		Loader.Show();

		var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
		var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

		var code = query.Get("code");

		if (string.IsNullOrEmpty(code))
		{
			Console.WriteLine("No authorization code found in URL.");
			Navigation.NavigateTo("/", forceLoad: false);
			return;
		}

		try
		{
			Console.WriteLine($"Sending code to backend for exchange: {code}");

			var payload = new AuthCodeExchangeRequest { Code = code };
			var response = await Http.PostAsJsonAsync("auth/exchange", payload);

			if (response.IsSuccessStatusCode)
			{
				// Read the raw JSON response for debugging
				var tokenJson = await response.Content.ReadAsStringAsync();
				Console.WriteLine("Received token response: " + tokenJson);

				// Deserialize using case-insensitive property names
				var token = JsonSerializer.Deserialize<AuthTokenResponse>(
					tokenJson,
					new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
				);

				if (token != null)
				{
					Console.WriteLine("Parsed AccessToken: " + token.AccessToken);
					Console.WriteLine("Parsed RefreshToken: " + token.RefreshToken);

					// Clear any old tokens before storing the new ones
					Console.WriteLine("Clearing old tokens...");
					await JS.InvokeVoidAsync("localStorage.removeItem", "access_token");
					await JS.InvokeVoidAsync("localStorage.removeItem", "refresh_token");

					// Store the access token using the TokenManager
					await TokenManager.SetTokenAsync(token.AccessToken);

					// Store the refresh token separately
					if (!string.IsNullOrWhiteSpace(token.RefreshToken))
					{
						await JS.InvokeVoidAsync("localStorage.setItem", "refresh_token", token.RefreshToken);
					}

					Console.WriteLine("Tokens stored successfully.");

					// Debug: Read them back and log
					var storedAccessToken = await JS.InvokeAsync<string>("localStorage.getItem", "access_token");
					var storedRefreshToken = await JS.InvokeAsync<string>("localStorage.getItem", "refresh_token");

					Console.WriteLine($"[AuthCallback] Stored access_token: {storedAccessToken}");
					Console.WriteLine($"[AuthCallback] Stored refresh_token: {storedRefreshToken}");

					// Wait for a second before redirecting to give the JS time to store the tokens
					await Task.Delay(200);
					Navigation.NavigateTo("/dashboard");
				}
				else
				{
					Console.WriteLine("Received null token object.");
					Navigation.NavigateTo("/", forceLoad: false);
				}

			}
			else
			{
				Console.WriteLine($"Token exchange failed. Status: {response.StatusCode}");
				Navigation.NavigateTo("/", forceLoad: false);
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Exception during token exchange: {ex.Message}");
			Navigation.NavigateTo("/", forceLoad: false);
		}
		finally
		{
			Loader.Hide();
		}
	}

	public class AuthCodeExchangeRequest
	{
		public string Code { get; set; }
	}
}